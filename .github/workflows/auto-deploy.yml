# GitHub Pages 自動部署腳本

name: Deploy to GitHub Pages
on:
  push:
    branches:
      only:
        - main
  workflow_run:
      name: Deploy to GitHub Pages
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Setup Node.js
          with:
            node-version: '20'
        - name: Deploy to GitHub Pages
          uses: peaceiris/actions-gh-pages@v4
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./
        - name: Setup Python for deployment
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'
        - name: Deploy to GitHub Pages with custom script
          run: |
            python3 -c "
            import json
            import os
            import subprocess
            import urllib.request
            import urllib.parse
            
            # 從環境變據讀取最新數據
            def get_latest_data():
                # 這裡可以從 DefiLlama API 獲取最新數據
                try:
                    # EdgeX
                    edgeX_response = urllib.request.urlopen('https://api.llama.fi/protocol/edgex')
                    edgeX_data = json.loads(edgeX_response.read())
                    edgeX_volume = edgeX_data.get('total24h', {}).get('volume', 0)
                    edgeX_oi = edgeX_data.get('total24h', {}).get('openInterest', 0)
                    
                    # Backpack
                    backpack_response = urllib.request.urlopen('https://api.llama.fi/protocol/backpack')
                    backpack_data = json.loads(backpack_response.read())
                    backpack_volume = backpack_data.get('total24h', {}).get('volume', 0)
                    backpack_oi = backpack_data.get('total24h', {}).get('openInterest', 0)
                    
                    # StandX
                    standx_response = urllib.request.urlopen('https://api.llama.fi/protocol/standx')
                    standx_data = json.loads(standx_response.read())
                    standx_volume = standx_data.get('total24h', {}).get('volume', 0)
                    standx_oi = standx_data.get('total24h', {}).get('openInterest', 0)
                    
                    return {
                        edgex: {
                            volume_24h: edgeX_volume,
                            oi: edgeX_oi
                        },
                        backpack: {
                            volume_24h: backpack_volume,
                            oi: backpack_oi
                        },
                        standx: {
                            volume_24h: standx_volume,
                            oi: standx_oi
                        }
                    }
                except Exception as e:
                    print(f'Error fetching data: {e}')
                    return {}
            
            # 更新 JavaScript 文件中的數據
            def update_dashboard_data():
                latest_data = get_latest_data()
                if latest_data:
                    print('Updating dashboard with latest data...')
                    print('EdgeX:', latest_data['edgex'])
                    print('Backpack:', latest_data['backpack'])
                    print('StandX:', latest_data['standx'])
                    
                    # 更新各項目的 volume 和 OI
                    edgex_volume = latest_data['edgex']['volume_24h']
                    edgex_oi = latest_data['edgex']['oi']
                    
                    backpack_volume = latest_data['backpack']['volume_24h']
                    backpack_oi = latest_data['backpack']['oi']
                    
                    standx_volume = latest_data['standx']['volume_24h']
                    standx_oi = latest_data['standx']['oi']
                    
                    # 這裡你可以手動調整數據
                    # 例如，如果需要更新其他項目，可以在此處理
                    
            except Exception as e:
                    print(f'Update failed: {e}')
            
            if __name__ == '__main__':
                update_dashboard_data()
                subprocess.run(['git', 'add', '.'], check=True)
                subprocess.run(['git', 'commit', '-m', 'Update dashboard with latest data from APIs', check=True])
                subprocess.run(['git', 'push'], check=True)
                print('✅ Dashboard data updated and deployed to GitHub Pages!')
            else:
                print('This script is designed for GitHub Actions')
            "

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
"